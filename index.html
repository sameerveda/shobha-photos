<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <style>
    .secrets-list {
      display: flex;
      flex-direction: column;
      padding: 0.5rem;
    }

    .secrets-list tr td:nth-child(even) {
      width: 99%;
      white-space: nowrap;
    }

    .secrets-list textarea {
      width: 100%;
    }
  </style>
  <body>
    <div x-data="root">
      <div style="border: 1px solid gray; padding: 0.25rem">
        <label style="border: 1px solid gray; padding: 0.25rem">
          Load Secrets
          <input type="file" @change="loadSecrets" accept=".json" />
        </label>
        <table class="secrets-list">
          <tbody>
            <tr>
              <td><label for="id24">client_id </label></td>
              <td>
                <textarea
                  rows="2"
                  id="id24"
                  type="text"
                  x-model="client_id"
                ></textarea>
              </td>
            </tr>
            <tr>
              <td><label for="id28">scope</label></td>
              <td>
                <textarea
                  rows="2"
                  id="id28"
                  type="text"
                  x-model="scope"
                ></textarea>
              </td>
            </tr>
            <tr>
              <td><label for="id32">DeveloperKey</label></td>
              <td>
                <textarea
                  rows="2"
                  id="id32"
                  type="text"
                  x-model="DeveloperKey"
                ></textarea>
              </td>
            </tr>
            <tr>
              <td><label for="id36">VIewID</label></td>
              <td>
                <select id="id36" x-model="viewId">
                  <template x-for="id in viewIds">
                    <option x-text="id"></option>
                  </template>
                </select>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p>
        <button x-show="!token" @click="login">Login</button>
        <button x-show="token" @click="showPicker">Show Picker</button>
      </p>
    </div>

    <script>
      // Use the API Loader script to load google.picker.
      function onApiLoad() {
        gapi.load("picker", () => console.log("picker loaded"));
      }
    </script>

    <script type="module">
      import Alpine from "https://unpkg.com/alpinejs@3.15.5/dist/module.esm.min.js";

      function validate(state) {
        for (const k in state) {
          const element = object[k];

          if (!state?.trim()) {
            alert(`${k} is required`);
            return false;
          }
        }
      }

      const SECRETS_SAVE_KEY = "SECRETS";
      const omitFields = new Set(["token", "viewIds"]);
      let version = 1;

      Alpine.data("root", () => ({
        token: "",
        scope: null,
        client_id: null,
        DeveloperKey: null,
        viewIds: [],
        viewId: "photos",
        get secrets() {
          return Object.freeze({
            scope: this.scope?.trim(),
            client_id: this.client_id.trim(),
            DeveloperKey: this.DeveloperKey.trim(),
            viewId: this.viewId.trim(),
          });
        },
        init() {
          this.setSecrets(localStorage.getItem(SECRETS_SAVE_KEY));
          this.initViewIds();

          this.$watch("secrets", (value) => {
            const v = ++version;

            setTimeout(() => {
              if (v !== version) return;

              localStorage.setItem(SECRETS_SAVE_KEY, JSON.stringify(value));
            }, 250);
          });
        },
        initViewIds(count = 1) {
          if (count > 10) throw new Error("failed initViewIds");

          if (!window.google?.picker?.ViewId)
            requestAnimationFrame(() => this.initViewIds(count + 1));
          else this.viewIds = Object.values(google.picker.ViewId);
        },
        loadSecrets(event) {
          if (!event.target.files[0]) return;

          const fs = new FileReader();
          fs.onloadend = () => this.setSecrets(fs.result);
          fs.readAsText(event.target.files[0]);
        },
        setSecrets(value) {
          if (!value) return;

          Object.assign(this, JSON.parse(value));
        },
        login() {
          const state = {
            client_id: this.secrets.client_id,
            scope: this.secrets.scope,
          };

          if (!validate(state)) return;

          // Replace with your client ID and required scopes.
          google.accounts.oauth2
            .initTokenClient({
              ...state,
              callback: (token) => ((this.token = token), console.log(token)),
            })
            .requestAccessToken();
        },

        showPicker() {
          if (
            !validate({
              DeveloperKey: this.secrets.DeveloperKey,
              viewId: this.secrets.viewId,
            })
          )
            return;

          // Replace with your API key and App ID.
          const picker = new google.picker.PickerBuilder()
            .addView(this.viewId)
            .setOAuthToken(this.token.access_token)
            .setDeveloperKey(this.DeveloperKey)
            .setCallback(console.log)
            .build();

          picker.setVisible(true);
        },
      }));

      Alpine.start();
    </script>

    <script
      async
      defer
      src="https://apis.google.com/js/api.js"
      onload="onApiLoad()"
    ></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
  </body>
</html>
