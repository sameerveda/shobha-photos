<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <style>
    .secrets-list {
      display: flex;
      flex-direction: column;
    }
  </style>
  <body>
    <div x-data="root">
      <div style="border: 1px solid gray; padding: 0.25rem">
        <label style="border: 1px solid gray; padding: 0.25rem">
          Load Secrets
          <input type="file" @change="loadSecrets" accept=".json" />
        </label>
        <table x-show="secrets" class="secrets-list">
          <tbody>
            <tr>
              <td><label for="id24">client_id </label></td>
              <td><input id="id24" type="text" x-model="client_id" /></td>
            </tr>
            <tr>
              <td><label for="id28">scope</label></td>
              <td><input id="id28" type="text" x-model="scope" /></td>
            </tr>
            <tr>
              <td><label for="id32">DeveloperKey</label></td>
              <td><input id="id32" type="text" x-model="DeveloperKey" /></td>
            </tr>
            <tr>
              <td><label for="id36">VIewID</label></td>
              <td>
                <select id="id36" x-model="viewId">
                  <template x-for="id in viewIds">
                    <option x-text="id"></option>
                  </template>
                </select>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p x-show="secrets">
        <button x-show="!token" @click="login">Login</button>
        <button x-show="token" @click="showPicker">Show Picker</button>
      </p>
    </div>

    <script>
      // Use the API Loader script to load google.picker.
      function onApiLoad() {
        gapi.load("picker", () => console.log("picker loaded"));
      }
    </script>

    <script type="module">
      import Alpine from "https://unpkg.com/alpinejs@3.15.5/dist/module.esm.min.js";

      Alpine.data("root", () => ({
        token: "",
        secrets: null,
        scope: null,
        client_id: null,
        DeveloperKey: null,
        viewIds: [],
        viewId: "photos",
        init() {
          this.setSecrets(localStorage.getItem("SECRETS"));
          this.initViewIds();
        },
        initViewIds(count = 1) {
          if (count > 10) throw new Error("failed initViewIds");

          if (!window.google?.picker?.ViewId)
            requestAnimationFrame(() => this.initViewIds(count + 1));
          else this.viewIds = Object.values(google.picker.ViewId);
        },
        loadSecrets(event) {
          if (!event.target.files[0]) return;

          const fs = new FileReader();
          fs.onloadend = () => this.setSecrets(fs.result);
          fs.readAsText(event.target.files[0]);
        },
        setSecrets(value) {
          if (!value) return;

          this.secrets = JSON.parse(value);
          this.client_id = this.secrets.client_id;
          this.scope = this.secrets.scope;
          this.DeveloperKey = this.secrets.DeveloperKey;

          localStorage.setItem("SECRETS", value);
        },
        login() {
          // Replace with your client ID and required scopes.
          google.accounts.oauth2
            .initTokenClient({
              client_id: this.secrets.client_id,
              scope: this.secrets.scope,
              callback: (token) => ((this.token = token), console.log(token)),
            })
            .requestAccessToken();
        },

        showPicker() {
          // Replace with your API key and App ID.
          const picker = new google.picker.PickerBuilder()
            .addView(this.viewId)
            .setOAuthToken(this.token.access_token)
            .setDeveloperKey(this.secrets.DeveloperKey)
            .setCallback(console.log)
            .build();

          picker.setVisible(true);
        },
      }));

      Alpine.start();
    </script>

    <script
      async
      defer
      src="https://apis.google.com/js/api.js"
      onload="onApiLoad()"
    ></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
  </body>
</html>
