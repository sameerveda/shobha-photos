<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <div x-data="root">
      <label style="border: 1px solid gray; padding: 0.25rem">
        Load Secrets <input type="file" @change="loadSecrets" accept=".json" />
      </label>
      <p x-show="secrets">
        <pre><code x-text="JSON.stringify(secrets, null, 2)"></code></pre>
      </p>

      <p x-show="secrets">
        <button x-show="!token" @click="login">Login</button>
        <button x-show="token" @click="showPicker">Show Picker</button>
      </p>
    </div>

    <script>
      // Use the API Loader script to load google.picker.
      function onApiLoad() {
        gapi.load("picker", () => console.log("picker loaded"));
      }
    </script>

    <script type="module">
      import Alpine from "https://unpkg.com/alpinejs@3.15.5/dist/module.esm.min.js";

      Alpine.data("root", () => ({
        token: "",
        secrets: null,
        init() {
          if(localStorage.getItem('SECRETS')) this.secrets = JSON.parse(localStorage.getItem('SECRETS')); 
        },
        loadSecrets(event) {
          if (!event.target.files[0]) return;

          const fs = new FileReader();
          fs.onloadend = () => {
            this.secrets = JSON.parse(fs.result);
            localStorage.setItem('SECRETS', fs.result);
          };
          fs.readAsText(event.target.files[0]);
        },
        login() {
          // Replace with your client ID and required scopes.
          google.accounts.oauth2
            .initTokenClient({
              client_id: this.secrets.client_id,
              scope: this.secrets.scope,
              callback: (token) => ((this.token = token), console.log(token)),
            })
            .requestAccessToken();
        },

        showPicker() {
          // Replace with your API key and App ID.
          const picker = new google.picker.PickerBuilder()
            .addView(google.picker.ViewId.DOCS)
            .setOAuthToken(this.token.access_token)
            .setDeveloperKey(this.secrets.DeveloperKey)
            .setCallback(console.log)
            .build();

          picker.setVisible(true);
        },
      }));

      Alpine.start();
    </script>

    <script
      async
      defer
      src="https://apis.google.com/js/api.js"
      onload="onApiLoad()"
    ></script>
    <script async defer src="https://accounts.google.com/gsi/client"></script>
  </body>
</html>
